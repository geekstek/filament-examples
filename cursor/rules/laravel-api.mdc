---
alwaysApply: true
description: Laravel API å¼€å‘å…¨æ ˆè§„èŒƒï¼ŒåŒ…å«æ§åˆ¶å™¨ã€Action/Service é€‰å‹åŠæ–‡æ¡£æ ‡å‡†
globs:
- "src/Http/Controllers/Api/**/*Controller.php"
- "src/Actions/**/*.phpâ€
- "src/Services/**/*.phpâ€
---

# Laravel API å¼€å‘è§„èŒƒæ‰‹å†Œ

æœ¬é¡¹ç›®åŸºäº **Laravel 12 + PHP 8.3**ï¼Œé‡‡ç”¨ä¸¥æ ¼çš„ **Action & Service** åˆ†å±‚æ¶æ„ã€‚æœ¬è§„èŒƒæ—¨åœ¨ç»Ÿä¸€ä»£ç é£æ ¼ï¼Œæå‡å¯ç»´æŠ¤æ€§ä¸åä½œæ•ˆç‡ã€‚

## 1. æ ¸å¿ƒæŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Laravel 12 (PHP 8.3+)
- **è®¤è¯**: Laravel Sanctum 4 / UACL
- **æƒé™**: spatie/laravel-permission
- **è·¯ç”±**: spatie/laravel-route-attributes
- **æ–‡æ¡£**: knuckleswtf/scribe
- **æ•°æ®**: spatie/laravel-data
- **æŸ¥è¯¢**: spatie/laravel-query-builder

---

## 2. æ§åˆ¶å™¨ (Controller) å¼€å‘è§„èŒƒ

æ§åˆ¶å™¨ä»…ä½œä¸º **HTTP å…¥å£**ï¼Œè´Ÿè´£æ¥æ”¶è¯·æ±‚ã€å‚æ•°æ ¡éªŒï¼ˆé€šè¿‡ DTO/Requestï¼‰ã€è°ƒç”¨ä¸šåŠ¡é€»è¾‘ï¼ˆAction/Serviceï¼‰å¹¶è¿”å›å“åº”ã€‚**ä¸¥ç¦åœ¨æ§åˆ¶å™¨ä¸­ç¼–å†™å¤æ‚ä¸šåŠ¡é€»è¾‘ã€‚**

### 2.1 åŸºç¡€ç»“æ„æ¨¡æ¿

æ‰€æœ‰ API æ§åˆ¶å™¨å¿…é¡»éµå¾ªä»¥ä¸‹ Attributes å£°æ˜æ–¹å¼ï¼š

```php
<?php

declare(strict_types=1);

namespace Geekstek\{PackageName}\Http\Controllers\Api\{SubNamespace};

use Geekstek\ApiLog\Http\Middleware\LogClientRequests;
use Illuminate\Routing\Controller;
use Knuckles\Scribe\Attributes\Authenticated;
use Knuckles\Scribe\Attributes\Endpoint;
use Knuckles\Scribe\Attributes\Group;
use Knuckles\Scribe\Attributes\Subgroup;
use Spatie\RouteAttributes\Attributes\RouteGroup;
use Spatie\RouteAttributes\Attributes\Middleware;

#[RouteGroup(prefix: 'api/{module-slug}', as: 'api.{module-slug}.')]
#[Middleware(['api', LogClientRequests::class])] // é»˜è®¤ä¸­é—´ä»¶
#[Group(name: 'ğŸ“¦ æ¨¡å—åç§°')]
#[Subgroup(name: 'ğŸ”§ åŠŸèƒ½å­ç±»')]
#[Authenticated] // è‹¥éœ€è®¤è¯
class {Resource}Controller extends Controller
{
    // ...
}
```

### 2.2 ä¾èµ–æ³¨å…¥

**å¼ºåˆ¶**ä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥ Serviceï¼Œ**Action**Â å»ºè®®åœ¨æ–¹æ³•å‚æ•°ä¸­æ³¨å…¥ã€‚

```php
// âœ… æ¨è
public function __construct(
    protected TokenService $tokenService, // æ³¨å…¥å¸¸ç”¨ Service
) {}

// æ–¹æ³•å‚æ•°æ³¨å…¥ Action (æŒ‰éœ€åŠ è½½)
public function store(CreateOrderData $data, CreateOrderAction $action)
{
    return $action->handle($data);
}
```

**âŒ ç¦æ­¢**ä½¿ç”¨Â app(Service::class)Â è¾…åŠ©å‡½æ•°è·å–å®ä¾‹ã€‚

### 2.3 è®¤è¯ä¸­é—´ä»¶ç­–ç•¥

æ ¹æ®æ¥å£æ€§è´¨é€‰æ‹© Middleware ç»„åˆï¼š

| **åœºæ™¯** | **ä¸­é—´ä»¶é…ç½®** | **ç¤ºä¾‹** |
| --- | --- | --- |
| **æ ‡å‡†åå°/ç”¨æˆ·æ¥å£** | `auth:uacl,platform` | é€šç”¨ä¸šåŠ¡æ¥å£ |
| **Token æ¥å£** | `auth:sanctum` | ç§»åŠ¨ç«¯/SPA æ¥å£ |
| **å›è°ƒ/å…¬å¼€æ¥å£** | ä»…Â `LogClientRequests` | æ”¯ä»˜å›è°ƒã€Webhooks |
| **å‰ç«¯ Slug æ ¡éªŒ** | `ValidateFrontendSlug` | å¤šç§Ÿæˆ·/Saas åœºæ™¯ |

## 3. å“åº”ä¸å¼‚å¸¸è§„èŒƒ

### 3.1 æˆåŠŸå“åº”

ä¼˜å…ˆä½¿ç”¨Â ResourceÂ ç±»ï¼Œæˆ–è€…ç»Ÿä¸€ç»“æ„çš„ JSON å“åº”ã€‚

```php
// æ–¹å¼ A: ä½¿ç”¨ Resource (æ¨è)
return UserResource::make($user)
    ->additional(['code' => 0, 'message' => 'æ“ä½œæˆåŠŸ', 'success' => true]);

// æ–¹å¼ B: ç›´æ¥ JSON (ä»…é™ç®€å•åœºæ™¯)
return response()->json([
    'data' => $data,
    'code' => 0,
    'message' => 'æ“ä½œæˆåŠŸ',
    'success' => true,
]);
```

### 3.2 é”™è¯¯å¤„ç†

æ§åˆ¶å™¨å±‚é¢ä¸»è¦å¤„ç†Â **HTTP å“åº”è½¬æ¢**ï¼Œä¸šåŠ¡å¼‚å¸¸åº”ç”±å…¨å±€ Handler æˆ–ä¸­é—´ä»¶æ•è·ï¼Œç‰¹æ®Šæƒ…å†µä½¿ç”¨ try-catchã€‚

```php
try {
    return $this->service->handleCallback($request);
} catch (BusinessException $e) {
    // ä¸šåŠ¡é€»è¾‘å·²çŸ¥é”™è¯¯ï¼Œè¿”å› 200/400 + é”™è¯¯ç 
    return response()->json([
        'success' => false,
        'code' => $e->getCode() ?: 500,
        'message' => $e->getMessage(),
    ]);
} catch (Exception $e) {
    // ç³»ç»Ÿçº§æœªçŸ¥é”™è¯¯ï¼Œè®°å½•æ—¥å¿—
    Log::error('ç³»ç»Ÿå¼‚å¸¸', ['error' => $e]);
    throw $e; // äº¤ç»™ Laravel Handler å¤„ç†
}
```

## 4. ä¸šåŠ¡é€»è¾‘åˆ†å±‚ä¸é€‰å‹æŒ‡å— (æ ¸å¿ƒ)

åœ¨å¼€å‘æ¥å£æ—¶ï¼Œå¿…é¡»å…ˆè¯„ä¼°é€»è¾‘å¤æ‚åº¦ï¼Œå†³å®šä»£ç æ”¾åœ¨Â **Action**Â è¿˜æ˜¯Â **Service**ã€‚

å‚è€ƒæ–‡æ¡£ @.cursor/templates/laravel-action-and-service.mdc Action å’Œ Service æ¶æ„åˆ†å±‚ä¸èŒè´£è§„èŒƒ

### 4.1 é€‰å‹å†³ç­–çŸ©é˜µ (Decision Matrix)

| **è¯„ä¼°ç»´åº¦** | **Action (ä¸šåŠ¡å‘½ä»¤)** | **Service (é¢†åŸŸèƒ½åŠ›)** |
| --- | --- | --- |
| **æ ¸å¿ƒèŒè´£** | **ç¼–æ’è€…**ï¼šåè°ƒèµ„æºï¼Œå®Œæˆä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡æ„å›¾ | **å·¥å…·ç®±**ï¼šæä¾›è®¡ç®—ã€æŸ¥è¯¢ã€æ ¡éªŒç­‰åŸå­èƒ½åŠ› |
| **è¯­ä¹‰** | "æˆ‘è¦åšä¸€ä¸ªåŠ¨ä½œ" (Command) | "æˆ‘éœ€è¦ä¸€ç§èƒ½åŠ›" (Capability) |
| **å‰¯ä½œç”¨** | **æœ‰**ï¼šä¿®æ”¹æ•°æ®åº“(CUD)ã€å‘é‚®ä»¶ã€è§¦å‘äº‹ä»¶ | **æ— /ä½**ï¼šçº¯è®¡ç®—ã€å¤æ‚æŸ¥è¯¢ã€ç¬¬ä¸‰æ–¹APIè°ƒç”¨ |
| **äº‹åŠ¡ç®¡ç†** | **å¿…é¡»è´Ÿè´£**å¼€å¯/æäº¤äº‹åŠ¡ | **ä¸¥ç¦**å¼€å¯äº‹åŠ¡ |
| **å¤ç”¨æ€§** | ä½ (é€šå¸¸ä½œä¸º API çš„å”¯ä¸€å…¥å£) | é«˜ (è¢«å¤šä¸ª Action å¤ç”¨) |
| **ä»£ç ç¤ºä¾‹** | `CreateOrderAction`,Â `ApproveLeaveAction` | `OrderCalculator`,Â `PaymentGatewayService` |

### 4.2 åœºæ™¯ä¸€ï¼šå¿…é¡»ä½¿ç”¨ Action

å½“æ¥å£å¯¹åº”ä¸€ä¸ªæ˜ç¡®çš„**â€œå†™æ“ä½œâ€**æˆ–**â€œå¤åˆæµç¨‹â€**æ—¶ã€‚

**ç‰¹å¾ï¼š**

1. éœ€è¦ä¿®æ”¹æ•°æ®çŠ¶æ€ï¼ˆCreate/Update/Deleteï¼‰ã€‚
2. éœ€è¦æ•°æ®åº“äº‹åŠ¡ï¼ˆTransactionï¼‰ã€‚
3. æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼ˆå¦‚ï¼šæ ¡éªŒ -> æ‰£åº“ -> ç”Ÿæˆè®¢å• -> å‘é€šçŸ¥ï¼‰ã€‚

**è§„èŒƒå†™æ³•ï¼š**

```php
// Controller
#[Post(uri: 'orders', name: 'orders.store')]
public function store(OrderData $data, PlaceOrderAction $action)
{
    // Controller åªè´Ÿè´£ä¼ å‚å’Œè¿”å›
    $order = $action->handle($data, Auth::user());
    return OrderResource::make($order);
}

// Action
class PlaceOrderAction
{
    public function handle(OrderData $data, User $user): Order
    {
        // Action è´Ÿè´£ç¼–æ’
        return DB::transaction(function () use ($data, $user) {
            $this->validator->check($user); // è°ƒ Service
            $order = $this->repo->create($data);
            $this->notifier->send($user);   // è°ƒ Service
            return $order;
        });
    }
}
```

### 4.3 åœºæ™¯äºŒï¼šå¿…é¡»ä½¿ç”¨ Service

å½“æ¥å£ä¸»è¦æ˜¯**â€œè¯»æ“ä½œâ€**ï¼Œæˆ–è€…é€»è¾‘ä»…æ¶‰åŠ**â€œå•ä¸€åŠŸèƒ½çš„å°è£…â€**æ—¶ã€‚

**ç‰¹å¾ï¼š**

1. å¤æ‚çš„æŸ¥è¯¢é€»è¾‘ã€æŠ¥è¡¨ç»Ÿè®¡ã€æ•°æ®èšåˆã€‚
2. ç¬¬ä¸‰æ–¹ API çš„å°è£…ï¼ˆå¦‚æ”¯ä»˜å›è°ƒå¤„ç†ã€ç‰©æµæŸ¥è¯¢ï¼‰ã€‚
3. çº¯è®¡ç®—é€»è¾‘ï¼ˆå¦‚ä»·æ ¼è®¡ç®—ã€è§„åˆ™æ ¡éªŒï¼‰ã€‚

**è§„èŒƒå†™æ³•ï¼š**

```php
// Controller
#[Post(uri: 'callbacks/payment', name: 'callbacks.payment')]
public function callback(Request $request)
{
    // ç›´æ¥è°ƒç”¨ Service çš„èƒ½åŠ›
    $result = $this->paymentService->handleWebhook($request->all());
    return response()->json($result);
}

// Service
class PaymentService
{
    public function handleWebhook(array $payload): array
    {
        // Service è´Ÿè´£å…·ä½“é€»è¾‘å®ç°ï¼Œä¸åŒ…å«äº‹åŠ¡ï¼ˆé™¤éæ˜¯çº¯é€»è¾‘è‡ªèº«é—­ç¯ï¼‰
        if (!$this->verifySignature($payload)) {
            throw new InvalidSignatureException();
        }
        return ['status' => 'success'];
    }
}
```

### 4.4 è‡ªæ£€å£è¯€

- **â€œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿâ€ (User Story)**Â Â â†’ å†™åœ¨Â **Action**ã€‚
- **â€œæ€ä¹ˆç®—çš„ / è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿâ€ (Rule/Calc)**Â Â â†’ å†™åœ¨Â **Service**ã€‚

## 5. è·¯ç”±ä¸æ–‡æ¡£è§„èŒƒ

### 5.1 Route Attributes æœ€ä½³å®è·µ

è·¯ç”±å®šä¹‰å¿…é¡»æ¸…æ™°ï¼ŒåŒ…å« HTTP æ–¹æ³•ã€URI å’Œè·¯ç”±åç§°ã€‚

```php
use Spatie\RouteAttributes\Attributes\Get;
use Spatie\RouteAttributes\Attributes\Post;
use Spatie\RouteAttributes\Attributes\WhereNumber;

// æ ‡å‡† RESTful å®šä¹‰
#[Get(uri: 'users', name: 'users.index')]
#[Post(uri: 'users', name: 'users.store')]
#[Get(uri: 'users/{id}', name: 'users.show')]
#[WhereNumber('id')] // å‚æ•°çº¦æŸ
public function show(int $id) { ... }
```

### 5.2 Scribe æ–‡æ¡£æ³¨è§£

æ¯ä¸ªæ¥å£å¿…é¡»åŒ…å«è¶³å¤Ÿç”Ÿæˆçš„æ–‡æ¡£ä¿¡æ¯ã€‚

```php
#[Endpoint(title: 'è·å–ç”¨æˆ·è¯¦æƒ…', description: 'è¿”å›ç”¨æˆ·çš„å®Œæ•´ä¿¡æ¯åŠå…³è”è§’è‰²')]
#[Header(name: 'X-Frontend-Slug', example: 'geekstek')]
#[ResponseFromApiResource(UserResource::class, User::class)]
#[Response(
    status: 404,
    description: 'ç”¨æˆ·ä¸å­˜åœ¨',
    content: ['success' => false, 'message' => 'Not Found']
)]
public function show(int $id) { ... }
```

## 6. å‘½åè§„èŒƒæ±‡æ€»

| **ç±»å‹** | **å‘½åæ ¼å¼** | **ç¤ºä¾‹** |
| --- | --- | --- |
| **URL** | kebab-case (çŸ­æ¨ªçº¿) | `api/user-orders/history` |
| **Controller** | PascalCase | `UserOrderController` |
| **Action** | `<Verb><Noun>Action` | `CreateOrderAction`,Â `ApproveUserAction` |
| **Service** | `<Noun><Capability>Service` | `OrderCalculatorService`,Â `PaymentGatewayService` |
| **Route Name** | snake_case (ç‚¹åˆ†) | `user_orders.history` |
| **DTO** | `<Action>Data` | `CreateOrderData` |

### æ€»ç»“ï¼šæ¥å£å¼€å‘ Checklist

1. **å®šä¹‰ DTO**: æ ¹æ®è¯·æ±‚å‚æ•°å®šä¹‰Â `Spatie Data`Â ç±»ã€‚
2. **é€‰å‹é€»è¾‘**:
    - æ˜¯å†™æ“ä½œ/å¤æ‚æµç¨‹ï¼ŸÂ Â â†’ åˆ›å»ºÂ `Action`ã€‚
    - æ˜¯è¯»æ“ä½œ/å•ä¸€èƒ½åŠ›ï¼ŸÂ Â â†’ åˆ›å»ºæˆ–å¤ç”¨Â `Service`ã€‚
3. **ç¼–å†™ Controller**:
    - æ·»åŠ  Route Attributesã€‚
    - æ·»åŠ  Scribe æ–‡æ¡£æ³¨è§£ã€‚
    - æ³¨å…¥ Action/Serviceã€‚
    - è°ƒç”¨å¹¶è¿”å› Resource/JSONã€‚
4. **æµ‹è¯•**: éªŒè¯è·¯ç”±ã€ä¸­é—´ä»¶åŠä¸šåŠ¡é€»è¾‘è¿”å›å€¼ã€‚
