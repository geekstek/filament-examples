---
description: Laravel 12 Model å¼€å‘è§„èŒƒä¸æœ€ä½³å®è·µ
globs: src/Models/*.php
---

# Laravel 12 Model å¼€å‘è§„èŒƒä¸æœ€ä½³å®è·µ

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

**è®© Model æ°¸è¿œä¿æŒâ€œè½»ã€ç¨³ã€å¯é¢„æµ‹â€ã€‚**

é˜²æ­¢ Model åœ¨é¡¹ç›®è¿­ä»£ 2-3 å¹´åè†¨èƒ€ä¸ºä¸å¯ç»´æŠ¤çš„â€œä¸Šå¸å¯¹è±¡â€ï¼ˆGod Objectï¼‰ã€‚
Model å¿…é¡»æ˜¯Â **â€œäº‹å®çš„è½½ä½“â€**ï¼Œè€Œä¸æ˜¯Â **â€œè¡Œä¸ºçš„æ‰§è¡Œè€…â€**ã€‚

## åŸºç¡€ç»“æ„è§„èŒƒ

**æ³¨æ„**: è¯·å‚è€ƒ @.cursor/templates/model-template.php.stub ç¤ºä¾‹æ–‡ä»¶

## ä¸€ã€Model çš„è§’è‰²å®šä¹‰

### âœ… Model æ˜¯ä»€ä¹ˆ

> Model æ˜¯é¢†åŸŸä¸­çš„â€œå®ä½“ï¼ˆEntityï¼‰â€ï¼Œ
è´Ÿè´£â€œæˆ‘æ˜¯è°ã€æˆ‘æœ‰ä»€ä¹ˆã€æˆ‘å’Œè°æœ‰å…³â€ã€‚
> 
1. **æˆ‘æ˜¯è°**ï¼ˆIdentityï¼‰
2. **æˆ‘æœ‰ä»€ä¹ˆ**ï¼ˆAttributes/Castsï¼‰
3. **æˆ‘å’Œè°æœ‰å…³**ï¼ˆRelationshipsï¼‰

### âŒ Model ä¸æ˜¯ä»€ä¹ˆ

- **ä¸æ˜¯**Â ä¸šåŠ¡æµç¨‹åè°ƒè€…ï¼ˆActionï¼‰
- **ä¸æ˜¯**Â æƒé™å†³ç­–ä¸­å¿ƒï¼ˆPolicyï¼‰
- **ä¸æ˜¯**Â UI / Filament é€‚é…å±‚
- **ä¸æ˜¯**Â å¤æ‚æŸ¥è¯¢é…ç½®ä¸­å¿ƒ

---

## äºŒã€ç°ä»£ Laravel ç»“æ„è§„èŒƒ (Laravel 12+)

åœ¨ Laravel 12 ä¸­ï¼Œæ¨èä½¿ç”¨Â **PHP Attributes**Â å’ŒÂ **æ–¹æ³•å¼å®šä¹‰**Â æ¥æ›¿ä»£æ—§çš„å±æ€§æ•°ç»„ã€‚

### 1. ç±»å£°æ˜ä¸ç­–ç•¥ç»‘å®š (Policy Binding)

ä½¿ç”¨Â #[UsePolicy]Â æ›¿ä»£Â AuthServiceProviderÂ æ³¨å†Œã€‚

```php
use App\Domain\Employees\Policies\EmployeeProfilePolicy;
use Geekstek\Uacl\Traits\Companyable; // å¦‚æœä½¿ç”¨company_id åštenantæ•°æ®éš”ç¦»æ—¶å¿…è¦
use Illuminate\Database\Eloquent\Attributes\UsePolicy;
use Illuminate\Database\Eloquent\Model;

#[UsePolicy(EmployeeProfilePolicy::class)]
class EmployeeProfile extends Model
{
    // Trait ä½¿ç”¨é¡ºåºï¼š
    // 1. ä¸šåŠ¡é€»è¾‘æ¥å£ Trait (Domain Traits)
    use Companyable;
    // 2. Laravel æ ¸å¿ƒåŠŸèƒ½ Trait
    use HasFactory, SoftDeletes;
    
    // ...
}
```

### 2. ç±»å‹è½¬æ¢ (Casts)

**å¼ºåˆ¶**ä½¿ç”¨Â casts()Â æ–¹æ³•ï¼ˆLaravel 12+ å¼•å…¥ï¼‰ï¼Œè€ŒéÂ $castsÂ å±æ€§ã€‚

```php
protected function casts(): array
{
    return [
        'joined_date'    => 'date:Y-m-d',
        'marital_status' => EmployeeMaritalStatus::class, // Enum
        'is_active'      => 'boolean',
        'amount'         => 'decimal:2',
        'meta_data'      => 'array',
        'created_at'     => 'datetime:Y-m-d H:i:s',
    ];
}
```

---

## ä¸‰ã€å†…å®¹ç™½åå• (å…è®¸å­˜åœ¨çš„ä»£ç )

åªæœ‰ä»¥ä¸‹å†…å®¹å…è®¸å‡ºç°åœ¨ Model ä¸­ï¼š

1. **åŸºç¡€é…ç½®**:Â `$table`,Â `$fillable`Â /Â `$guarded`,Â `$hidden`.
2. **Eloqunet å…³è”**:Â `HasOne`,Â `BelongsToMany`Â ç­‰ï¼ˆè¿™æ˜¯ Model çš„æ ¸å¿ƒèŒè´£ï¼‰ã€‚
3. **çº¯å±æ€§æ´¾ç”Ÿ (Attribute/Accessor)**:
    - å¿…é¡»ä½¿ç”¨Â `Attribute::make()`Â æˆ– `protected` æ–¹æ³•ã€‚
    - **ä¸¥ç¦**åœ¨ Accessor ä¸­æŸ¥è¯¢æ•°æ®åº“æˆ–è°ƒç”¨å¤–éƒ¨æœåŠ¡ã€‚
4. **æç®€çŠ¶æ€åˆ¤æ–­**:
    - `isActive()`,Â `isSuperAdmin()`
    - **é™åˆ¶**: â‰¤ 5 è¡Œï¼Œæ— å‰¯ä½œç”¨ï¼Œä¸æŸ¥åº“ã€‚
5. **é€šçŸ¥è·¯ç”±**:Â `routeNotificationForMail()`Â ç­‰ã€‚
6. **æŸ¥è¯¢èŒƒå›´ (Scope)**: ä»…é™äºç®€å•çš„Â `WHERE`Â ç»„è£…ã€‚

---

## å››ã€å†…å®¹çº¢çº¿ (ä¸¥ç¦å­˜åœ¨çš„ä»£ç )

### âŒ 1. ä¸šåŠ¡æµç¨‹ (Action / Command)

**ç¦æ­¢**åœ¨ Model ä¸­æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡åŠ¨ä½œã€‚

```php
// ğŸš« é”™è¯¯
$user->applyLeave(); 
$user->approveContract();

// âœ… æ­£ç¡®ï¼šç§»è‡³ Action ç±»
app(ApplyLeaveAction::class)->execute($user, $data);
```

### âŒ 2. æƒé™åˆ¤æ–­ (Policy / Gate)

**ç¦æ­¢**åœ¨ Model ä¸­å†™æƒé™é€»è¾‘ã€‚

```php
// ğŸš« é”™è¯¯
$user->canAccessPanel();

// âœ… æ­£ç¡®ï¼šç§»è‡³ Policy
$user->can('view', $panel);
```

### âŒ 3. UI / å‰ç«¯é€»è¾‘

**ç¦æ­¢**åŒ…å«ç‰¹å®šäº Filament æˆ–å‰ç«¯å±•ç¤ºçš„é€»è¾‘ã€‚

- ä¾‹å¤–ï¼šå¦‚æœå¿…é¡»å®ç°æ¥å£ï¼ˆå¦‚Â FilamentUserï¼‰ï¼Œå¿…é¡»ç›´æ¥å§”æ‰˜ç»™ Serviceï¼ˆè§ç¬¬å…­èŠ‚ï¼‰ã€‚

### âŒ 4. å¤–éƒ¨ä¾èµ–ä¸é…ç½®

- ç¦æ­¢ä¾èµ– HTTP Clientã€‚
- ç¦æ­¢ä¾èµ– Spatie æƒé™çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆsetPermissionsTeamIdï¼‰ã€‚
- ç¦æ­¢â€œé…ç½®å‹æ–¹æ³•â€ (å¦‚Â getAllowedFilters) â€”â€” é€™æ˜¯ Query Object çš„èŒè´£ã€‚

---

## äº”ã€ä½“é‡ä¸å¤æ‚åº¦æŒ‡æ ‡ (å¼ºåˆ¶)

| **æŒ‡æ ‡** | **é™åˆ¶** | **è¯´æ˜** |
| --- | --- | --- |
| **æ ¸å¿ƒæ¨¡å‹è¡Œæ•°** | â‰¤ 300 è¡Œ | å¦‚ User, Order |
| **æ™®é€šæ¨¡å‹è¡Œæ•°** | â‰¤ 200 è¡Œ | å¤§å¤šæ•°ä¸šåŠ¡æ¨¡å‹ |
| **å…³è”æ¨¡å‹è¡Œæ•°** | â‰¤ 120 è¡Œ | Pivot è¡¨æ¨¡å‹ |
| **å•æ–¹æ³•è¡Œæ•°** | â‰¤ 20 è¡Œ | ä¿æŒçŸ­å°ç²¾æ‚ |
| **åµŒå¥—å±‚çº§** | â‰¤ 2 å±‚ | ç¦æ­¢æ·±å±‚ if/else |
| **å¾ªç¯æŸ¥è¯¢** | ç¦æ­¢ | ä¸¥ç¦ foreach ä¸­æ‰§è¡Œ query |

---

## å…­ã€å‘½åè§„èŒƒ

### 1. æ–¹æ³•å‘½å

- **âœ… æ­£ç¡®ï¼ˆæè¿°çŠ¶æ€ï¼‰**:Â isActive(),Â hasAvatar(),Â belongsToCompany()
- **âŒ é”™è¯¯ï¼ˆæè¿°è¡Œä¸ºï¼‰**:Â apply(),Â approve(),Â process()Â â€”â€” è¡Œä¸ºå±äº Action å±‚ã€‚

### 2. Scope å‘½åä¸å®ç°

ä½¿ç”¨ Attributes å®šä¹‰ Scopeï¼ˆå¦‚é¡¹ç›®æ”¯æŒï¼‰æˆ–æ ‡å‡†å‘½åã€‚

```php
use Illuminate\Database\Eloquent\Attributes\Scope;

/**
 * æŒ‰å‘˜å·¥IDæŸ¥è¯¢
 */
#[Scope]
public function employee(Builder $query, int $employeeId): void
{
    $query->where('employee_id', $employeeId);
}
```

æ³¨æ„ **"å¯ä»¥ç”¨ï¼Œä½†è¦å…‹åˆ¶"**

å¯ä»¥ç”¨ï¼Œä½†åªé€‚åˆâ€œé¢†åŸŸæ— æ­§ä¹‰ã€ç¨³å®šã€è·¨ä¸Šä¸‹æ–‡é€šç”¨â€çš„ Scopeã€‚
åœ¨ä½ è¿™ä¸ªè§„æ¨¡ä¸‹ï¼Œå®ƒä¸æ˜¯é»˜è®¤é€‰é¡¹ï¼Œè€Œæ˜¯å—æ§é€‰é¡¹ã€‚

ä»€ä¹ˆæ—¶å€™â€œé€‚åˆâ€ç”¨ Attribute Scope
ç¬¦åˆä»¥ä¸‹ å…¨éƒ¨æ¡ä»¶ æ‰å»ºè®®ç”¨ï¼š
è¯­ä¹‰ç¨³å®šã€ä¸ä¼šéšæƒé™å˜åŒ–
ä¸ä¼šæºæ‚ä¸šåŠ¡è§„åˆ™
ä¸ä¼šä¾èµ–å½“å‰ç”¨æˆ· / è§’è‰² / ç»„ç»‡
é•¿æœŸå­˜åœ¨ï¼ˆ2â€“3 å¹´ä¸ä¼šè¢«æ¨ç¿»ï¼‰

```
#[Scope]
public function active(Builder $query): Builder
{
    return $query->where('is_active', true);
}

#[Scope]
public function ofCompany(Builder $query, int $companyId): Builder
{
    return $query->where('company_id', $companyId);
}
```
è¿™äº› scope çš„ç‰¹ç‚¹æ˜¯ï¼š

- æè¿°æ•°æ®çŠ¶æ€
- ä¸â€œè°åœ¨çœ‹â€æ— å…³
- ä¸ä¼šå·å·å¸ä¸šåŠ¡é€»è¾‘

å“ªäº› Scope ç¦æ­¢ç”¨ Attributeï¼ˆéå¸¸é‡è¦ï¼‰
âŒ ä»»ä½•æ¶‰åŠâ€œæƒé™ / å½“å‰ç”¨æˆ· / ä¸Šä¸‹æ–‡â€çš„ scope
```
#[Scope] // âŒ ç¦æ­¢
public function accessibleBy(Builder $query, User $user)
```

âŒ ä»»ä½•ä¼šè¢« Filament / API / Job ä¸åŒå…¥å£å¤ç”¨ï¼Œä½†è§„åˆ™ä¸åŒçš„ scope
```
#[Scope] // âŒ 2å¹´åä¸€å®šæ‹†
public function visible()
```

è¿™ç§ scope æ˜¯â€œæ…¢æ€§æ¯’è¯â€ï¼Œ
å‰æœŸçˆ½ï¼ŒåæœŸå¿…ç‚¸ã€‚

Attribute Scope åªå…è®¸ç”¨äºâ€œæ•°æ®ç»´åº¦â€ï¼Œ
ä¸å…è®¸ç”¨äºâ€œè®¿é—®ç»´åº¦ / ä¸šåŠ¡ç»´åº¦â€ã€‚

è®¿é—®ç»´åº¦ â†’ Query Service / Query Policy
ä¸šåŠ¡ç»´åº¦ â†’ Action / Service

---

## ä¸ƒã€ç‰¹æ®Šæƒ…å†µå¤„ç† (ä¾‹å¤–æœºåˆ¶)

**å”¯ä¸€å…è®¸çš„ä¾‹å¤–**ï¼šå½“æ¡†æ¶æˆ–ç¬¬ä¸‰æ–¹åŒ…ï¼ˆå¦‚ Filamentï¼‰å¼ºåˆ¶è¦æ±‚ Model å®ç°ç‰¹å®šæ¥å£æ–¹æ³•æ—¶ã€‚

**è§„åˆ™**ï¼š

1. æ–¹æ³•ä½“Â **â‰¤ 10 è¡Œ**ã€‚
2. å†…éƒ¨é€»è¾‘å¿…é¡»Â **100% å§”æ‰˜**Â ç»™ Serviceã€‚

```php
// å®ç° FilamentUser æ¥å£
public function canAccessPanel(Panel $panel): bool
{
    // å§”æ‰˜ç»™ä¸“é—¨çš„ Service å¤„ç†
    return app(UserPanelAccessService::class)->canAccess($this, $panel);
}
```

---

## å…«ã€æ¨èç›®å½•ç»“æ„ (DDD é£æ ¼)

å»ºè®®æŒ‰é¢†åŸŸï¼ˆDomainï¼‰ç»„ç»‡ä»£ç ï¼Œè€ŒéæŒ‰æŠ€æœ¯ç±»å‹åˆ†å±‚ã€‚

```php
src/Domain/
 â”œâ”€ Users/
 â”‚  â”œâ”€ Models/
 â”‚  â”‚  â””â”€ User.php
 â”‚  â”œâ”€ Services/
 â”‚  â”‚  â”œâ”€ UserPanelAccessService.php  <-- æ‰¿æ¥ UI é€»è¾‘
 â”‚  â”‚  â””â”€ UserDataScopeService.php
 â”‚  â”œâ”€ Actions/
 â”‚  â”‚  â””â”€ CreateUserAction.php        <-- æ‰¿æ¥ä¸šåŠ¡è¡Œä¸º
 â”‚  â”œâ”€ Policies/
 â”‚  â”‚  â””â”€ UserPolicy.php              <-- æ‰¿æ¥æƒé™
 â”‚  â””â”€ Queries/
 â”‚     â””â”€ UserQueryPolicy.php         <-- æ‰¿æ¥å¤æ‚æŸ¥è¯¢é…ç½®
```

---

## ä¹ã€Code Review æ£€æŸ¥æ¸…å• (Checklist)

æäº¤ä»£ç å‰ï¼Œè¯·å¯¹ç…§ä»¥ä¸‹é—®é¢˜è‡ªæŸ¥ã€‚**ä»»æ„ä¸€æ¡å‘½ä¸­ï¼Œå¿…é¡»é‡æ„**ã€‚

- æ˜¯å¦åŒ…å«å…·ä½“çš„ä¸šåŠ¡æµç¨‹ä»£ç ï¼ˆåº”åœ¨ Actionï¼‰ï¼Ÿ
- æ˜¯å¦åŒ…å«æƒé™åˆ¤æ–­é€»è¾‘ï¼ˆåº”åœ¨ Policyï¼‰ï¼Ÿ
- æ˜¯å¦åŒ…å« Filament é¢æ¿çš„é…ç½®æˆ– UI å†³ç­–ï¼ˆåº”åœ¨ Service/Resourceï¼‰ï¼Ÿ
- æ˜¯å¦å­˜åœ¨è¶…è¿‡ 20 è¡Œçš„æ–¹æ³•ï¼Ÿ
- æ˜¯å¦è¿›è¡Œäº†è·¨èšåˆ/è·¨è¡¨çš„å¤æ‚è”åˆæŸ¥è¯¢ï¼ˆåº”åœ¨ Query Objectï¼‰ï¼Ÿ

---

**CTO æ€»ç»“**ï¼š

å½“ä½ èƒ½åšåˆ°**â€œè¡Œä¸ºåœ¨ Actionï¼Œè§„åˆ™åœ¨ Serviceï¼Œæƒé™åœ¨ Policyï¼ŒModel åªä¿ç•™â€˜æˆ‘æ˜¯è°â€™â€**æ—¶ï¼Œä½ çš„ç³»ç»Ÿå°±å·²ç»è¿›å…¥äº†é•¿æœŸå¯ç»´æŠ¤çš„å®‰å…¨åŒºé—´ã€‚