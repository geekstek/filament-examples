<?php

declare(strict_types=1);

namespace Geekstek\XXX\Filament\Resources\YYY\Tables; // XXX替换为实际的业务命名空间, YYY替换为模型名(复数)

use Filament\Actions\ActionGroup;
use Filament\Actions\BulkActionGroup;
use Filament\Actions\DeleteAction;
use Filament\Actions\DeleteBulkAction;
use Filament\Actions\EditAction;
use Filament\Actions\ExportBulkAction;
use Filament\Actions\ViewAction;
use Filament\Facades\Filament;
use Filament\Tables\Columns\ImageColumn;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Enums\FiltersLayout;
use Filament\Tables\Filters\Filter;
use Filament\Tables\Filters\SelectFilter;
use Filament\Tables\Table;
use Geekstek\ActivityLog\Filament\Resources\ActivityLogs\Actions\ActivityLogTimelineTableAction;
use Geekstek\XXX\Filament\Resources\YYY\Actions\ZZZAction;
use Geekstek\XXX\Filament\Resources\YYY\Exports\YYYExporter;
use Geekstek\XXX\Models\YYY;
use Geekstek\Community\Models\Community;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Carbon;
use Malzariey\FilamentDaterangepickerFilter\Filters\DateRangeFilter;

class YYYResource
{
    public const TRANSLATIONS = 'XXX::resources/YYY.';

    public static function configure(Table $table): Table
    {
        return $table
            ->columns([
                TextColumn::make('id')
                    ->label(__(self::TRANSLATIONS . 'fields.id.label'))
                    ->sortable()
                    ->searchable()
                    ->toggleable(isToggledHiddenByDefault: true),
                ImageColumn::make('user.avatar')
                    ->label(__(self::TRANSLATIONS . 'fields.avatar.label'))
                    ->circular()
                    ->imageSize(100)
                    ->simpleLightbox()
                    ->toggleable(),
                TextColumn::make('employee_number')
                    ->label(__(self::TRANSLATIONS . 'fields.employee_number.label'))
                    ->sortable()
                    ->searchable()
                    ->toggleable(),
                TextColumn::make('joined_date')
                    ->label(__(self::TRANSLATIONS . 'fields.joined_date.label'))
                    ->date('Y-m-d')
                    ->sortable()
                    ->searchable()
                    ->toggleable(),
                TextColumn::make('organization_users')
                    ->label(__(self::TRANSLATIONS . 'fields.organization-users.label'))
                    ->state(function (YYY $record) {
                        $result = [];

                        foreach ($record->organizationUsers as $row) {
                            if ($row->organization?->name && $row->position?->name) {
                                $result[] = $row->position->name . ' (' . ($row->organization->name ?? '') . ')';
                            }
                        }

                        return $result;
                    })
                    ->listWithLineBreaks()
                    ->badge()
                    ->placeholder('没有关联组织用户')
                    ->searchable(query: function ($query, $search) {
                        return $query->whereHas('organizationUsers', function ($query) use ($search) {
                            $query->where(function ($query) use ($search) {
                                $query->whereHas('organization', function ($query) use ($search) {
                                    $query->where('name', 'like', "%{$search}%");
                                })
                                    ->orWhereHas('position', function ($query) use ($search) {
                                        $query->where('name', 'like', "%{$search}%");
                                    });
                            });
                        });
                    })
                    ->action(ZZZAction::make()),
                TextColumn::make('remark')
                    ->label(__(self::TRANSLATIONS . 'fields.remark.label'))
                    ->limit(50)
                    ->toggleable(isToggledHiddenByDefault: true),
                TextColumn::make('created_at')
                    ->label(__(self::TRANSLATIONS . 'fields.created_at.label'))
                    ->sortable()
                    ->searchable()
                    ->toggleable(isToggledHiddenByDefault: true),
                TextColumn::make('updated_at')
                    ->label(__(self::TRANSLATIONS . 'fields.updated_at.label'))
                    ->sortable()
                    ->searchable()
                    ->toggleable(isToggledHiddenByDefault: true),
            ])
            ->filters([
                SelectFilter::make('community')
                    ->label('社区')
                    ->options(function () {
                        return Community::query()
                            ->where('company_id', Filament::getTenant()->id)
                            ->orderBy('name')
                            ->pluck('name', 'id');
                    })
                    ->searchable()
                    ->preload()
                    ->query(function (Builder $query, array $data): Builder {
                        if (empty($data['value'])) {
                            return $query;
                        }

                        return $query->whereHas('organizationUsers', function ($q) use ($data) {
                            $q->whereHas('organization', function ($orgQuery) use ($data) {
                                $orgQuery->whereJsonContains('metadata->is_community', true)
                                    ->whereJsonContains('metadata->community_id', (int) $data['value'])
                                    ->whereHas('organizationType', function ($typeQuery) {
                                        $typeQuery->where('slug', 'administrative');
                                    });
                            });
                        });
                    }),

                SelectFilter::make('position')
                    ->label('职位')
                    ->relationship('organizationUsers.position', 'name')
                    ->native(false)
                    ->multiple()
                    ->preload()
                    ->searchable()
                    ->query(function (Builder $query, array $data): Builder {
                        if (empty($data['values'])) {
                            return $query;
                        }

                        return $query->whereHas('organizationUsers.position', function ($query) use ($data) {
                            $query->whereIn('id', $data['values']);
                        });
                    }),

                DateRangeFilter::make('created_at')
                    ->label('创建时间')
                    ->displayFormat('YYYY-MM-DD')
                    ->format('Y-m-d'),
                DateRangeFilter::make('updated_at')
                    ->label('更新时间')
                    ->displayFormat('YYYY-MM-DD')
                    ->format('Y-m-d'),
                Filter::make('birthday_this_and_next_month')
                    ->label('本月及下月生日')
                    ->query(
                        fn (Builder $query): Builder => $query
                            ->whereHas('userProfile', function (Builder $query) {
                                $currentMonth = Carbon::now()->month;
                                $nextMonth = Carbon::now()->addMonth()->month;

                                // 获取本月和下月的月份数字
                                $query->whereRaw('MONTH(date_of_birth) IN (?, ?)', [$currentMonth, $nextMonth]);
                            })
                    )
                    ->toggle(),
                SelectFilter::make('has_social_insurance')
                    ->label(__(self::TRANSLATIONS . 'fields.has_social_insurance.label'))
                    ->options([
                        '1' => '是',
                        '0' => '否',
                    ])
                    ->native(false),
            ], layout: FiltersLayout::Modal)
            ->filtersFormColumns(2)
            ->recordActions([
                ActionGroup::make([
                    ViewAction::make(),
                    EditAction::make(),
                    DeleteAction::make(),
                    ActivityLogTimelineTableAction::make()
                        ->authorize('activity'),
                ]),
            ])
            ->toolbarActions([
                BulkActionGroup::make([
                    DeleteBulkAction::make(),
                    ExportBulkAction::make()
                        ->exporter(YYYExporter::class)
                        ->authorize('export'),
                ]),
            ])
            ->persistColumnSearchesInSession()
            ->persistFiltersInSession()
            ->persistSearchInSession()
            ->persistSortInSession()
            ->searchOnBlur()
            ->searchDebounce('500ms')
            ->recordAction(null)
            ->recordUrl(null)
            ->striped()
            ->defaultSort('created_at', 'desc');
    }
}
